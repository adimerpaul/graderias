import{Q as C}from"./QSpace-CuTDVUuC.js";import{_ as U,c as g,o as c,w as a,a as s,Q as B,e as v,b as r,t as m,f as _,ac as w,an as I,aa as D,a9 as b,af as q,ao as y,a8 as u,F as M,ab as Q,h as P,a5 as R,ap as N}from"./index-B2nkVPlK.js";import{Q as k}from"./QSelect-o66SLZ4v.js";import{Q as G}from"./QForm-CgpTDaNu.js";import{Q as A,f as x,g as z,a as V,d as E,e as f}from"./format-CJ8u8jQh.js";import{Q as F}from"./QPage-DQ9M_k89.js";import{C as L}from"./ClosePopup-Bll_qURG.js";const T={name:"GraderiaForm",data(){return{loading:!1,loadingSeats:!1,showPreview:!0,seatDBMap:{},seatDialog:{open:!1,seat:null,seatStatus:"LIBRE",db:null},statusMeta:{LIBRE:{label:"Libre",color:"positive",bg:"#82f38b"},RESERVADO:{label:"Reservado",color:"warning",bg:"#f3d77d"},PAGADO:{label:"Pagado",color:"primary",bg:"#79bcee"},BLOQUEADO:{label:"Bloqueado",color:"negative",bg:"#ec7385"}},form:{nombre:"",direccion:"",filas:10,columnas:10,etiqueta_modo:"fila",start_top:!0,start_left:!0,activo:!0,regenerar_asientos:!1}}},computed:{isEdit(){return!!this.$route.params.id},totalAsientos(){const o=Number(this.form.filas||0),e=Number(this.form.columnas||0);return Math.max(0,o)*Math.max(0,e)},previewRows(){return Math.min(Number(this.form.filas||0),30)},previewCols(){return Math.min(Number(this.form.columnas||0),30)},previewSeats(){const o=this.previewRows,e=this.previewCols;if(o<=0||e<=0)return[];const n=this.form.start_top?this.range(1,o):this.range(1,o).reverse(),d=this.form.start_left?this.range(1,e):this.range(1,e).reverse(),t=[];for(const i of n){const l=[];for(const h of d){const p=this.makeCode(i,h),S=this.seatDBMap[p],O=this.normalizeEstado(S?.estado)||"LIBRE";l.push({code:p,r:i,c:h,fila:i,columna:h,status:O})}t.push(l)}return t}},watch:{"form.filas"(){this.seatDBMap={}},"form.columnas"(){this.seatDBMap={}},"form.etiqueta_modo"(){this.seatDBMap={}},"form.start_top"(){this.seatDBMap={}},"form.start_left"(){this.seatDBMap={}}},mounted(){this.isEdit&&this.getOne()},methods:{req(o){return o!=null&&o!==""||"Campo requerido"},normalizeEstado(o){if(!o)return"";const e=String(o).toUpperCase();return["LIBRE","RESERVADO","PAGADO","BLOQUEADO"].includes(e)?e:""},range(o,e){const n=[];for(let d=o;d<=e;d++)n.push(d);return n},numToLetters(o){let e="";for(o=Number(o);o>0;)o--,e=String.fromCharCode(65+o%26)+e,o=Math.floor(o/26);return e},makeCode(o,e){return this.form.etiqueta_modo==="fila"?`${this.numToLetters(o)}${e}`:`${this.numToLetters(e)}${o}`},openSeatDialog(o){const e=this.seatDBMap[o.code]||null,n=this.normalizeEstado(e?.estado)||o.status||"LIBRE";this.seatDialog.seat=o,this.seatDialog.db=e,this.seatDialog.seatStatus=n,this.seatDialog.open=!0},loadSeatsPreview(){if(!this.isEdit)return;this.loadingSeats=!0;const o=this.$route.params.id;this.$axios.get(`mis-graderias/${o}`,{params:{preview_rows:this.previewRows,preview_cols:this.previewCols}}).then(e=>{const n=e.data,d=n.graderia;this.form={nombre:d.nombre||"",direccion:d.direccion||"",filas:d.filas||1,columnas:d.columnas||1,etiqueta_modo:d.etiqueta_modo||"fila",start_top:!!d.start_top,start_left:!!d.start_left,activo:!!d.activo,regenerar_asientos:!1};const t={},i=n.asientos_preview||[];for(const l of i)t[l.codigo]=l;this.seatDBMap=t}).catch(e=>this.$alert.error(e.response?.data?.message||"No se pudo cargar asientos (preview)")).finally(()=>{this.loadingSeats=!1})},getOne(){this.loading=!0,this.$axios.get(`mis-graderias/${this.$route.params.id}`,{params:{preview_rows:this.previewRows,preview_cols:this.previewCols}}).then(o=>{const e=o.data,n=e.graderia;this.form={nombre:n.nombre||"",direccion:n.direccion||"",filas:n.filas||1,columnas:n.columnas||1,etiqueta_modo:n.etiqueta_modo||"fila",start_top:!!n.start_top,start_left:!!n.start_left,activo:!!n.activo,regenerar_asientos:!1};const d={},t=e.asientos_preview||[];for(const i of t)d[i.codigo]=i;this.seatDBMap=d}).catch(o=>this.$alert.error(o.response?.data?.message||"No se pudo cargar")).finally(()=>{this.loading=!1})},save(){this.loading=!0;const o=this.$route.params.id,e={...this.form};(this.isEdit?this.$axios.put(`mis-graderias/${o}`,e):this.$axios.post("mis-graderias",e)).then(()=>{this.$alert.success(this.isEdit?"Gradería actualizada":"Gradería creada"),this.$router.push("/mis-graderias")}).catch(d=>this.$alert.error(d.response?.data?.message||"No se pudo guardar")).finally(()=>{this.loading=!1})}}},j={class:"text-subtitle1 text-weight-bold"},X={class:"text-caption text-grey-7"},Y={class:"row q-col-gutter-xs"},H={class:"col-12 col-md-6"},J={class:"col-12 col-md-6"},K={class:"col-6 col-md-2"},W={class:"col-6 col-md-2"},Z={class:"col-12 col-md-3"},$={class:"col-12 col-md-3"},ee={class:"col-6 col-md-2"},te={class:"col-6 col-md-2"},se={key:0,class:"col-12"},oe={class:"row justify-end q-gutter-sm q-mt-sm"},ae={class:"row items-center q-col-gutter-sm q-mb-sm"},le={class:"col-12 col-md-8"},re={class:"text-caption text-grey-7"},ie={class:"col-12 col-md-4"},ne={class:"row items-center justify-end q-gutter-xs"},de={style:{width:"100%",overflow:"auto"}},ue={border:"1",cellpadding:"6",cellspacing:"0",width:"100%"},me=["bgcolor","onClick"],ce={style:{"font-size":"11px"}},fe={class:"text-subtitle1 text-weight-bold"},pe={class:"text-caption text-grey-7"};function ge(o,e,n,d,t,i){return c(),g(F,{class:"q-pa-sm"},{default:a(()=>[s(B,{flat:"",bordered:""},{default:a(()=>[s(v,{class:"row items-center q-py-sm"},{default:a(()=>[r("div",null,[r("div",j,m(i.isEdit?"Editar Gradería":"Nueva Gradería"),1),r("div",X,m(i.isEdit?"Actualiza la gradería":"Crea la gradería y genera asientos automáticamente"),1)]),s(C),s(_,{flat:"",icon:"arrow_back",label:"Volver","no-caps":"",onClick:e[0]||(e[0]=l=>o.$router.push("/mis-graderias"))})]),_:1}),s(w),s(v,{class:"q-pa-sm"},{default:a(()=>[s(G,{onSubmit:I(i.save,["prevent"])},{default:a(()=>[r("div",Y,[r("div",H,[s(q,{modelValue:t.form.nombre,"onUpdate:modelValue":e[1]||(e[1]=l=>t.form.nombre=l),label:"Nombre",dense:"",outlined:"",rules:[i.req]},null,8,["modelValue","rules"])]),r("div",J,[s(q,{modelValue:t.form.direccion,"onUpdate:modelValue":e[2]||(e[2]=l=>t.form.direccion=l),label:"Dirección",dense:"",outlined:""},null,8,["modelValue"])]),r("div",K,[s(q,{modelValue:t.form.filas,"onUpdate:modelValue":e[3]||(e[3]=l=>t.form.filas=l),modelModifiers:{number:!0},type:"number",label:"Filas (X)",dense:"",outlined:"",rules:[i.req]},null,8,["modelValue","rules"])]),r("div",W,[s(q,{modelValue:t.form.columnas,"onUpdate:modelValue":e[4]||(e[4]=l=>t.form.columnas=l),modelModifiers:{number:!0},type:"number",label:"Columnas (Y)",dense:"",outlined:"",rules:[i.req]},null,8,["modelValue","rules"])]),r("div",Z,[s(k,{modelValue:t.form.etiqueta_modo,"onUpdate:modelValue":e[5]||(e[5]=l=>t.form.etiqueta_modo=l),dense:"",outlined:"",label:"Etiquetado",options:["fila","columna"],rules:[i.req]},null,8,["modelValue","rules"])]),r("div",$,[s(k,{modelValue:t.form.activo,"onUpdate:modelValue":e[6]||(e[6]=l=>t.form.activo=l),dense:"",outlined:"",label:"Estado",options:[{label:"Activo",value:!0},{label:"Inactivo",value:!1}],"emit-value":"","map-options":""},null,8,["modelValue"])]),r("div",ee,[s(y,{modelValue:t.form.start_top,"onUpdate:modelValue":e[7]||(e[7]=l=>t.form.start_top=l),label:"Empieza arriba"},null,8,["modelValue"])]),r("div",te,[s(y,{modelValue:t.form.start_left,"onUpdate:modelValue":e[8]||(e[8]=l=>t.form.start_left=l),label:"Empieza izquierda"},null,8,["modelValue"])]),i.isEdit?(c(),D("div",se,[s(y,{modelValue:t.form.regenerar_asientos,"onUpdate:modelValue":e[9]||(e[9]=l=>t.form.regenerar_asientos=l),label:"Regenerar asientos (borra y crea de nuevo)",color:"negative"},null,8,["modelValue"])])):b("",!0)]),r("div",oe,[s(_,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[10]||(e[10]=l=>o.$router.push("/mis-graderias")),disable:t.loading},null,8,["disable"]),s(_,{color:"primary",label:i.isEdit?"Guardar":"Crear gradería","no-caps":"",type:"submit",loading:t.loading},null,8,["label","loading"])])]),_:1},8,["onSubmit"]),s(w,{class:"q-mt-md q-mb-md"}),s(B,{flat:"",bordered:"",class:"q-mt-sm"},{default:a(()=>[s(v,{class:"row items-center q-py-sm"},{default:a(()=>[e[14]||(e[14]=r("div",{class:"text-subtitle2 text-weight-bold"},"Vista previa de asientos",-1)),s(C),s(A,{outline:"",color:"primary",class:"q-mr-sm"},{default:a(()=>[u(" Total: "+m(i.totalAsientos),1)]),_:1}),i.isEdit?(c(),g(_,{key:0,dense:"","no-caps":"",color:"primary",icon:"refresh",label:"Recargar",loading:t.loadingSeats,onClick:e[11]||(e[11]=l=>i.loadSeatsPreview()),class:"q-mr-sm"},null,8,["loading"])):b("",!0),s(y,{modelValue:t.showPreview,"onUpdate:modelValue":e[12]||(e[12]=l=>t.showPreview=l),dense:"",label:"Mostrar"},null,8,["modelValue"])]),_:1}),s(w),t.showPreview?(c(),g(v,{key:0,class:"q-pa-sm"},{default:a(()=>[r("div",ae,[r("div",le,[r("div",re,[u(" Preview limitado a "+m(i.previewRows)+" x "+m(i.previewCols)+". Click en un asiento ",1),e[15]||(e[15]=r("b",null,"LIBRE",-1)),e[16]||(e[16]=u(" para ver info en un diálogo. ",-1))])]),r("div",ie,[r("div",ne,[s(x,{dense:"",color:t.statusMeta.LIBRE.color,"text-color":"white",icon:"event_seat"},{default:a(()=>[...e[17]||(e[17]=[u("LIBRE",-1)])]),_:1},8,["color"]),s(x,{dense:"",color:t.statusMeta.RESERVADO.color,"text-color":"white",icon:"bookmark"},{default:a(()=>[...e[18]||(e[18]=[u("RESERVADO",-1)])]),_:1},8,["color"]),s(x,{dense:"",color:t.statusMeta.PAGADO.color,"text-color":"white",icon:"paid"},{default:a(()=>[...e[19]||(e[19]=[u("PAGADO",-1)])]),_:1},8,["color"]),s(x,{dense:"",color:t.statusMeta.BLOQUEADO.color,"text-color":"white",icon:"block"},{default:a(()=>[...e[20]||(e[20]=[u("BLOQUEADO",-1)])]),_:1},8,["color"])])])]),r("div",de,[r("table",ue,[r("tbody",null,[(c(!0),D(M,null,Q(i.previewSeats,(l,h)=>(c(),D("tr",{key:h},[(c(!0),D(M,null,Q(l,p=>(c(),D("td",{key:p.code,bgcolor:t.statusMeta[p.status].bg,onClick:S=>i.openSeatDialog(p),style:{cursor:"pointer","text-align":"center"}},[r("div",null,[r("b",null,m(p.code),1)]),r("div",ce,m(t.statusMeta[p.status].label),1)],8,me))),128))]))),128))])])])]),_:1})):b("",!0)]),_:1}),s(P,{modelValue:t.seatDialog.open,"onUpdate:modelValue":e[13]||(e[13]=l=>t.seatDialog.open=l)},{default:a(()=>[s(B,{style:{"min-width":"420px","max-width":"92vw"}},{default:a(()=>[s(v,{class:"row items-center q-py-sm"},{default:a(()=>[r("div",null,[r("div",fe," Asiento: "+m(t.seatDialog.seat?.code),1),r("div",pe," Fila: "+m(t.seatDialog.seat?.fila)+" — Columna: "+m(t.seatDialog.seat?.columna),1)]),s(C),R(s(_,{dense:"",flat:"",round:"",icon:"close"},null,512),[[L]])]),_:1}),s(w),s(v,{class:"q-pt-sm"},{default:a(()=>[s(A,{color:t.statusMeta[t.seatDialog.seatStatus].color,"text-color":"white",class:"q-mb-md"},{default:a(()=>[u(m(t.statusMeta[t.seatDialog.seatStatus].label),1)]),_:1},8,["color"]),s(z,{bordered:"",separator:""},{default:a(()=>[s(V,null,{default:a(()=>[s(E,null,{default:a(()=>[s(f,null,{default:a(()=>[...e[21]||(e[21]=[u("Descripción",-1)])]),_:1}),s(f,{caption:""},{default:a(()=>[u(m(t.seatDialog.db?.descripcion||"—"),1)]),_:1})]),_:1})]),_:1}),t.seatDialog.seatStatus!=="LIBRE"?(c(),g(V,{key:0},{default:a(()=>[s(E,null,{default:a(()=>[s(f,null,{default:a(()=>[...e[22]||(e[22]=[u("Cliente",-1)])]),_:1}),s(f,{caption:""},{default:a(()=>[u(m(t.seatDialog.db?.cliente_nombre||"—")+" — "+m(t.seatDialog.db?.cliente_celular||"—"),1)]),_:1})]),_:1})]),_:1})):b("",!0),t.seatDialog.seatStatus!=="LIBRE"?(c(),g(V,{key:1},{default:a(()=>[s(E,null,{default:a(()=>[s(f,null,{default:a(()=>[...e[23]||(e[23]=[u("Monto",-1)])]),_:1}),s(f,{caption:""},{default:a(()=>[u(m(t.seatDialog.db?.monto??"—"),1)]),_:1})]),_:1})]),_:1})):b("",!0),t.seatDialog.db?.reservado_at?(c(),g(V,{key:2},{default:a(()=>[s(E,null,{default:a(()=>[s(f,null,{default:a(()=>[...e[24]||(e[24]=[u("Reservado",-1)])]),_:1}),s(f,{caption:""},{default:a(()=>[u(m(t.seatDialog.db.reservado_at),1)]),_:1})]),_:1})]),_:1})):b("",!0),t.seatDialog.db?.pagado_at?(c(),g(V,{key:3},{default:a(()=>[s(E,null,{default:a(()=>[s(f,null,{default:a(()=>[...e[25]||(e[25]=[u("Pagado",-1)])]),_:1}),s(f,{caption:""},{default:a(()=>[u(m(t.seatDialog.db.pagado_at),1)]),_:1})]),_:1})]),_:1})):b("",!0)]),_:1}),e[26]||(e[26]=r("div",{class:"text-caption text-grey-7 q-mt-sm"}," * Este diálogo es solo informativo. La administración se hará en otra pantalla. ",-1))]),_:1}),s(w),s(N,{align:"right"},{default:a(()=>[R(s(_,{flat:"","no-caps":"",label:"Cerrar"},null,512),[[L]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})}const Ee=U(T,[["render",ge]]);export{Ee as default};
