import{Q as U}from"./QSpace-Bo-Ef_EY.js";import{E as _e,ag as G,Y as Se,ah as Te,$ as De,g as Ee,r as J,z as A,ai as Ue,a1 as Ae,aj as Oe,a2 as Ne,ak as ze,p as K,m as Z,L as $,R as ee,al as Fe,j as se,am as Ge,G as Ie,X as je,_ as Be,c as m,o as n,w as t,a as s,Q as O,e as k,b as c,af as C,d as b,aa as x,a9 as I,F as j,ab as B,a8 as g,t as P,ae as Le,a5 as _,ac as He,f as p,h as L,an as Me,ao as Re,ap as We}from"./index-CeXL2F7p.js";import{v as Xe,h as ae,u as Ye,p as le,i as Je,j as Ke,k as Ze,r as te,s as $e,c as oe,f as ie,Q as re,g as ne,a as V,d as f,e as S}from"./format-BJkB64Wj.js";import{Q as es}from"./QBtnDropdown-BUQl5k_d.js";import{Q as ss,a as N}from"./QTable-Bx0donx6.js";import{Q as as}from"./QImg-DKX_FBTD.js";import{Q as ls}from"./QSelect-CPi3UJ0h.js";import{Q as ts}from"./QForm-CNfsoDVi.js";import{Q as os}from"./QPage-fddfUdsb.js";import{C as T}from"./ClosePopup-CJo7hj1B.js";const is=_e({name:"QTooltip",inheritAttrs:!1,props:{...Ye,...De,...G,maxHeight:{type:String,default:null},maxWidth:{type:String,default:null},transitionShow:{...G.transitionShow,default:"jump-down"},transitionHide:{...G.transitionHide,default:"jump-up"},anchor:{type:String,default:"bottom middle",validator:ae},self:{type:String,default:"top middle",validator:ae},offset:{type:Array,default:()=>[14,14],validator:Xe},scrollTarget:Te,delay:{type:Number,default:0},hideDelay:{type:Number,default:0},persistent:Boolean},emits:[...Se],setup(l,{slots:e,emit:h,attrs:d}){let o,i;const a=Ee(),{proxy:{$q:r}}=a,w=J(null),D=J(!1),ue=A(()=>le(l.anchor,r.lang.rtl)),de=A(()=>le(l.self,r.lang.rtl)),me=A(()=>l.persistent!==!0),{registerTick:ce,removeTick:fe}=Ue(),{registerTimeout:E}=Ae(),{transitionProps:ge,transitionStyle:pe}=Oe(l),{localScrollTarget:H,changeScrollEvent:he,unconfigureScrollTarget:ve}=Je(l,X),{anchorEl:v,canShow:be,anchorEvents:q}=Ke({showing:D,configureAnchorEl:Ve}),{show:we,hide:z}=Ne({showing:D,canShow:be,handleShow:ke,handleHide:Ce,hideOnRouteChange:me,processOnMount:!0});Object.assign(q,{delayShow:xe,delayHide:Pe});const{showPortal:M,hidePortal:R,renderPortal:ye}=ze(a,w,Qe,"tooltip");if(r.platform.is.mobile===!0){const u={anchorEl:v,innerRef:w,onClickOutside(y){return z(y),y.target.classList.contains("q-dialog__backdrop")&&je(y),!0}},F=A(()=>l.modelValue===null&&l.persistent!==!0&&D.value===!0);K(F,y=>{(y===!0?Ze:te)(u)}),Z(()=>{te(u)})}function ke(u){M(),ce(()=>{i=new MutationObserver(()=>Q()),i.observe(w.value,{attributes:!1,childList:!0,characterData:!0,subtree:!0}),Q(),X()}),o===void 0&&(o=K(()=>r.screen.width+"|"+r.screen.height+"|"+l.self+"|"+l.anchor+"|"+r.lang.rtl,Q)),E(()=>{M(!0),h("show",u)},l.transitionDuration)}function Ce(u){fe(),R(),W(),E(()=>{R(!0),h("hide",u)},l.transitionDuration)}function W(){i!==void 0&&(i.disconnect(),i=void 0),o!==void 0&&(o(),o=void 0),ve(),$(q,"tooltipTemp")}function Q(){$e({targetEl:w.value,offset:l.offset,anchorEl:v.value,anchorOrigin:ue.value,selfOrigin:de.value,maxHeight:l.maxHeight,maxWidth:l.maxWidth})}function xe(u){if(r.platform.is.mobile===!0){oe(),document.body.classList.add("non-selectable");const F=v.value,y=["touchmove","touchcancel","touchend","click"].map(Y=>[F,Y,"delayHide","passiveCapture"]);ee(q,"tooltipTemp",y)}E(()=>{we(u)},l.delay)}function Pe(u){r.platform.is.mobile===!0&&($(q,"tooltipTemp"),oe(),setTimeout(()=>{document.body.classList.remove("non-selectable")},10)),E(()=>{z(u)},l.hideDelay)}function Ve(){if(l.noParentEvent===!0||v.value===null)return;const u=r.platform.is.mobile===!0?[[v.value,"touchstart","delayShow","passive"]]:[[v.value,"mouseenter","delayShow","passive"],[v.value,"mouseleave","delayHide","passive"]];ee(q,"anchor",u)}function X(){if(v.value!==null||l.scrollTarget!==void 0){H.value=Fe(v.value,l.scrollTarget);const u=l.noParentEvent===!0?Q:z;he(H.value,u)}}function qe(){return D.value===!0?se("div",{...d,ref:w,class:["q-tooltip q-tooltip--style q-position-engine no-pointer-events",d.class],style:[d.style,pe.value],role:"tooltip"},Ie(e.default)):null}function Qe(){return se(Ge,ge.value,qe)}return Z(W),Object.assign(a.proxy,{updatePosition:Q}),ye}}),rs={name:"UsuariosPage",data(){return{users:[],user:{},userDialog:!1,loading:!1,filter:"",roles:["Administrador","Soporte","Operador","Cliente"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"avatar",label:"Avatar",align:"left",field:l=>l.avatar},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"email",label:"Email",align:"left",field:"email"},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permissions",label:"Permisos",align:"left",field:l=>(l.permissions||[]).map(e=>e.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1}},mounted(){this.usersGet()},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const l=this.permFilter.toLowerCase();return this.permissions.filter(e=>e.name.toLowerCase().includes(l))}},methods:{req(l){return!!l||"Campo requerido"},imgUser(l){return`${this.$url}../../images/${l}`},userNew(){this.user={name:"",username:"",email:"",password:"",role:"Operador"},this.userDialog=!0},userEdit(l){this.user={...l},this.userDialog=!0},usersGet(){this.loading=!0,this.$axios.get("users").then(l=>{this.users=l.data}).catch(l=>this.$alert.error(l.response?.data?.message||"Error cargando usuarios")).finally(()=>{this.loading=!1})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario creado"),this.usersGet()}).catch(l=>this.$alert.error(l.response?.data?.message||"No se pudo crear")).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put(`users/${this.user.id}`,this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario actualizado"),this.usersGet()}).catch(l=>this.$alert.error(l.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})},userDelete(l){this.$alert.dialog("¿Desea eliminar el usuario?").onOk(()=>{this.loading=!0,this.$axios.delete(`users/${l}`).then(()=>{this.$alert.success("Usuario eliminado"),this.usersGet()}).catch(e=>this.$alert.error(e.response?.data?.message||"No se pudo eliminar")).finally(()=>{this.loading=!1})})},userEditPassword(l){this.user={...l},this.$alert.dialogPrompt("Nueva contraseña","Ingrese la nueva contraseña","password").onOk(e=>{this.loading=!0,this.$axios.put(`updatePassword/${l.id}`,{password:e}).then(()=>{this.$alert.success("Contraseña actualizada"),this.usersGet()}).catch(h=>this.$alert.error(h.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})})},cambiarAvatar(l){this.user={...l},this.cambioAvatarDialogo=!0},onFileChange(l){const e=l.target.files[0];if(!e)return;const h=new FormData;h.append("avatar",e),this.loading=!0,this.$axios.post(`${this.user.id}/avatar`,h,{headers:{"Content-Type":"multipart/form-data"}}).then(()=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(d=>this.$alert.error(d.response?.data?.message||"No se pudo subir avatar")).finally(()=>{this.loading=!1})},async permisosShow(l){this.user={...l},this.dialogPermisos=!0,this.loading=!0;try{const e=await this.$axios.get("permissions").then(d=>d.data),h=await this.$axios.get(`users/${l.id}/permissions`).then(d=>d.data);this.permissions=e.map(d=>({...d,checked:h.includes(d.id)}))}catch(e){this.$alert.error(e.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const l=this.permissions.filter(e=>e.checked).map(e=>e.id);await this.$axios.put(`users/${this.user.id}/permissions`,{permissions:l}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.usersGet()}catch(l){this.$alert.error(l.response?.data?.message||"No se pudo guardar permisos")}finally{this.loading=!1}}}},ns={class:"row items-center q-col-gutter-xs"},us={class:"text-left"},ds={class:"text-subtitle1 text-weight-bold"},ms={class:"row justify-end q-gutter-sm"},cs={class:"row items-start q-col-gutter-md"},fs={class:"col-12"},gs={class:"avatar-box"},ps=["src"],hs={key:1,class:"row items-center justify-center avatar-img"},vs={class:"row justify-end q-gutter-sm q-mt-md"};function bs(l,e,h,d,o,i){return n(),m(os,{class:"q-pa-md"},{default:t(()=>[s(O,{flat:"",bordered:"",class:"q-mb-md"},{default:t(()=>[s(k,{class:"row items-center"},{default:t(()=>[e[19]||(e[19]=c("div",null,[c("div",{class:"text-h6 text-title"},"Usuarios"),c("div",{class:"text-caption text-grey-7"},"Gestión de usuarios, roles, permisos y avatar")],-1)),s(U),s(C,{modelValue:o.filter,"onUpdate:modelValue":e[0]||(e[0]=a=>o.filter=a),label:"Buscar",dense:"",outlined:"",debounce:"300",style:{width:"280px"}},{append:t(()=>[s(b,{name:"search"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),s(ss,{rows:o.users,columns:o.columns,"row-key":"id",dense:"",flat:"",bordered:"","wrap-cells":"",filter:o.filter,"rows-per-page-options":[0],"loading-label":"Cargando...","no-data-label":"Sin registros"},{"top-right":t(()=>[s(p,{color:"positive",label:"Nuevo","no-caps":"",icon:"add_circle_outline",loading:o.loading,class:"q-mr-sm",onClick:i.userNew},null,8,["loading","onClick"]),s(p,{color:"primary",label:"Actualizar","no-caps":"",icon:"refresh",loading:o.loading,onClick:i.usersGet},null,8,["loading","onClick"])]),"body-cell-actions":t(a=>[s(N,{props:a,class:"text-center"},{default:t(()=>[s(es,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:t(()=>[s(ne,null,{default:t(()=>[_((n(),m(V,{clickable:"",onClick:r=>i.userEdit(a.row)},{default:t(()=>[s(f,{avatar:""},{default:t(()=>[s(b,{name:"edit"})]),_:1}),s(f,null,{default:t(()=>[s(S,null,{default:t(()=>[...e[20]||(e[20]=[g("Editar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[T]]),_((n(),m(V,{clickable:"",onClick:r=>i.userEditPassword(a.row)},{default:t(()=>[s(f,{avatar:""},{default:t(()=>[s(b,{name:"lock_reset"})]),_:1}),s(f,null,{default:t(()=>[s(S,null,{default:t(()=>[...e[21]||(e[21]=[g("Cambiar contraseña",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[T]]),_((n(),m(V,{clickable:"",onClick:r=>i.cambiarAvatar(a.row)},{default:t(()=>[s(f,{avatar:""},{default:t(()=>[s(b,{name:"image"})]),_:1}),s(f,null,{default:t(()=>[s(S,null,{default:t(()=>[...e[22]||(e[22]=[g("Cambiar avatar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[T]]),_((n(),m(V,{clickable:"",onClick:r=>i.permisosShow(a.row)},{default:t(()=>[s(f,{avatar:""},{default:t(()=>[s(b,{name:"lock"})]),_:1}),s(f,null,{default:t(()=>[s(S,null,{default:t(()=>[...e[23]||(e[23]=[g("Permisos",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[T]]),s(He),_((n(),m(V,{clickable:"",onClick:r=>i.userDelete(a.row.id)},{default:t(()=>[s(f,{avatar:""},{default:t(()=>[s(b,{name:"delete"})]),_:1}),s(f,null,{default:t(()=>[s(S,null,{default:t(()=>[...e[24]||(e[24]=[g("Eliminar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[T]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-avatar":t(a=>[s(N,{props:a},{default:t(()=>[s(Le,{rounded:"",size:"42px"},{default:t(()=>[a.row.avatar?(n(),m(as,{key:0,src:i.imgUser(a.row.avatar)},null,8,["src"])):(n(),m(b,{key:1,name:"person",size:"28px"}))]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":t(a=>[s(N,{props:a},{default:t(()=>[s(ie,{label:a.row.role,color:l.$filters.color(a.row.role),"text-color":"white",dense:"",size:"13px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-permissions":t(a=>[s(N,{props:a},{default:t(()=>[c("div",ns,[(n(!0),x(j,null,B((a.row.permissions||[]).slice(0,3),(r,w)=>(n(),m(ie,{key:r.id||w,dense:"",color:"grey-3","text-color":"black",size:"12px",class:"q-mr-xs q-mb-xs"},{default:t(()=>[g(P(r.name),1)]),_:2},1024))),128)),(a.row.permissions||[]).length>3?(n(),m(re,{key:0,outline:"",color:"primary",class:"q-ml-xs"},{default:t(()=>[g(" +"+P((a.row.permissions||[]).length-3)+" ",1),s(is,{anchor:"top middle",self:"bottom middle",offset:[0,8]},{default:t(()=>[c("div",us,[(n(!0),x(j,null,B(a.row.permissions,r=>(n(),x("div",{key:r.id},"• "+P(r.name),1))),128))])]),_:2},1024)]),_:2},1024)):I("",!0),(a.row.permissions||[]).length?I("",!0):(n(),m(re,{key:1,color:"grey-5",outline:""},{default:t(()=>[...e[25]||(e[25]=[g(" Sin permisos ",-1)])]),_:1}))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),s(L,{modelValue:o.userDialog,"onUpdate:modelValue":e[9]||(e[9]=a=>o.userDialog=a),persistent:""},{default:t(()=>[s(O,{style:{width:"420px","max-width":"95vw"}},{default:t(()=>[s(k,{class:"row items-center q-pb-none"},{default:t(()=>[c("div",ds,P(o.user.id?"Editar usuario":"Nuevo usuario"),1),s(U),s(p,{icon:"close",flat:"",round:"",dense:"",onClick:e[1]||(e[1]=a=>o.userDialog=!1)})]),_:1}),s(k,{class:"q-pt-sm"},{default:t(()=>[s(ts,{onSubmit:e[8]||(e[8]=Me(a=>o.user.id?i.userPut():i.userPost(),["prevent"]))},{default:t(()=>[s(C,{modelValue:o.user.name,"onUpdate:modelValue":e[2]||(e[2]=a=>o.user.name=a),label:"Nombre",dense:"",outlined:"",rules:[i.req],class:"q-mb-sm"},null,8,["modelValue","rules"]),s(C,{modelValue:o.user.username,"onUpdate:modelValue":e[3]||(e[3]=a=>o.user.username=a),label:"Usuario",dense:"",outlined:"",rules:[i.req],class:"q-mb-sm"},null,8,["modelValue","rules"]),s(C,{modelValue:o.user.email,"onUpdate:modelValue":e[4]||(e[4]=a=>o.user.email=a),label:"Email",dense:"",outlined:"",type:"email",class:"q-mb-sm"},null,8,["modelValue"]),o.user.id?I("",!0):(n(),m(C,{key:0,modelValue:o.user.password,"onUpdate:modelValue":e[5]||(e[5]=a=>o.user.password=a),label:"Contraseña",dense:"",outlined:"",type:"password",rules:[i.req],class:"q-mb-sm"},null,8,["modelValue","rules"])),s(ls,{modelValue:o.user.role,"onUpdate:modelValue":e[6]||(e[6]=a=>o.user.role=a),label:"Rol",dense:"",outlined:"",options:o.roles,rules:[i.req],class:"q-mb-md"},null,8,["modelValue","options","rules"]),c("div",ms,[s(p,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[7]||(e[7]=a=>o.userDialog=!1),disable:o.loading},null,8,["disable"]),s(p,{color:"primary",label:"Guardar","no-caps":"",type:"submit",loading:o.loading},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(L,{modelValue:o.cambioAvatarDialogo,"onUpdate:modelValue":e[14]||(e[14]=a=>o.cambioAvatarDialogo=a),persistent:""},{default:t(()=>[s(O,{style:{width:"420px","max-width":"95vw"}},{default:t(()=>[s(k,{class:"row items-center q-pb-none text-weight-bold"},{default:t(()=>[e[26]||(e[26]=g(" Cambiar avatar ",-1)),s(U),s(p,{icon:"close",flat:"",round:"",dense:"",onClick:e[10]||(e[10]=a=>o.cambioAvatarDialogo=!1)})]),_:1}),s(k,{class:"q-pt-sm"},{default:t(()=>[c("div",cs,[c("div",fs,[c("div",gs,[s(p,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:e[11]||(e[11]=a=>l.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""}),o.user.avatar?(n(),x("img",{key:0,src:i.imgUser(o.user.avatar),class:"avatar-img"},null,8,ps)):(n(),x("div",hs,[s(b,{name:"person",size:"88px"})])),c("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:e[12]||(e[12]=(...a)=>i.onFileChange&&i.onFileChange(...a)),accept:"image/*"},null,544)])])]),c("div",vs,[s(p,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[13]||(e[13]=a=>o.cambioAvatarDialogo=!1),disable:o.loading},null,8,["disable"])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(L,{modelValue:o.dialogPermisos,"onUpdate:modelValue":e[18]||(e[18]=a=>o.dialogPermisos=a),persistent:""},{default:t(()=>[s(O,{style:{"min-width":"420px","max-width":"95vw"}},{default:t(()=>[s(k,{class:"row items-center q-pb-none text-weight-bold"},{default:t(()=>[g(" Permisos de "+P(o.user.username)+" ",1),s(U),s(p,{icon:"close",flat:"",round:"",dense:"",onClick:e[15]||(e[15]=a=>o.dialogPermisos=!1)})]),_:1}),s(k,{class:"q-pt-sm"},{default:t(()=>[s(C,{modelValue:o.permFilter,"onUpdate:modelValue":e[16]||(e[16]=a=>o.permFilter=a),dense:"",outlined:"",placeholder:"Filtrar permisos...",class:"q-mb-sm"},{append:t(()=>[s(b,{name:"search"})]),_:1},8,["modelValue"]),s(ne,{dense:"",bordered:"",class:"rounded-borders"},{default:t(()=>[(n(!0),x(j,null,B(i.filteredPermissions,a=>(n(),m(V,{key:a.id},{default:t(()=>[s(f,null,{default:t(()=>[g(P(a.name),1)]),_:2},1024),s(f,{side:""},{default:t(()=>[s(Re,{modelValue:a.checked,"onUpdate:modelValue":r=>a.checked=r},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(We,{align:"right"},{default:t(()=>[s(p,{color:"negative",label:"Cancelar","no-caps":"",flat:"",onClick:e[17]||(e[17]=a=>o.dialogPermisos=!1),disable:o.loading},null,8,["disable"]),s(p,{color:"primary",label:"Guardar","no-caps":"",onClick:i.permisosPost,loading:o.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Ss=Be(rs,[["render",bs],["__scopeId","data-v-941692cd"]]);export{Ss as default};
